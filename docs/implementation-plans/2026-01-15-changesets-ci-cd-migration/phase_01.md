# Changesets CI/CD Migration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use ed3d-plan-and-execute:executing-an-implementation-plan to implement this plan task-by-task.

**Goal:** Migrate from release-please to Changesets for release management, adopting patterns from the grounds project.

**Architecture:** Single OIDC entry point (`publish-switch.yml`) routes to alpha and release workflows. Custom `generate-changeset.ts` script converts conventional commits to changesets. Alpha releases publish to npm with `@alpha` tag using snapshot versioning.

**Tech Stack:** @changesets/cli, conventional-commits-parser, tsx, GitHub Actions, npm OIDC

**Scope:** 5 phases from original design (phases 1-5)

**Codebase verified:** 2026-01-15

**Testing approach:** This project uses fixture-based testing with Vitest. Tests are in `tests/generation.test.ts`. CI/CD workflow changes are verified operationally (workflow runs succeed), not via unit tests.

---

## Phase 1: Changesets Foundation

**Goal:** Set up Changesets configuration and dependencies

### Task 1: Add Changesets dependencies to package.json

**Files:**

- Modify: `/Users/brajkovic/Code/containerfile-ts/.worktrees/changesets-ci-cd-migration/package.json:49-57`

**Step 1: Add new devDependencies**

Add these dependencies to the `devDependencies` section in `package.json`:

```json
{
  "devDependencies": {
    "@changesets/cli": "^2.29.8",
    "@commitlint/cli": "^20.1.0",
    "@commitlint/config-conventional": "^20.1.0",
    "conventional-commits-parser": "^6.2.1",
    "husky": "^9.1.0",
    "lint-staged": "^15.2.0",
    "oxlint": "^0.15.0",
    "tsx": "^4.21.0",
    "typescript": "^5.7.0",
    "vitest": "^4.0.16"
  }
}
```

Note: The new dependencies are `@changesets/cli`, `conventional-commits-parser`, and `tsx`. The parser includes its own TypeScript types in v6.x. Keep existing dependencies in alphabetical order.

**Step 2: Install dependencies**

Run: `pnpm install`

Expected: Installation succeeds with new packages added to `pnpm-lock.yaml`

**Step 3: Commit**

```bash
git add package.json pnpm-lock.yaml
git commit -m "$(cat <<'EOF'
chore: add changesets and conventional-commits-parser dependencies

Adds @changesets/cli for release management, conventional-commits-parser
for parsing commit messages, and tsx for running TypeScript scripts.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 2: Create Changesets configuration

**Files:**

- Create: `/Users/brajkovic/Code/containerfile-ts/.worktrees/changesets-ci-cd-migration/.changeset/config.json`

**Step 1: Create the .changeset directory and config file**

Create `.changeset/config.json` with this content:

```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.1.2/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

Configuration explanation:

- `access: "public"` - Required for public npm packages
- `baseBranch: "main"` - Matches this project's main branch
- `commit: false` - We'll handle commits manually/via GitHub Actions
- `changelog: "@changesets/cli/changelog"` - Uses default changelog format

**Step 2: Create a placeholder README for the .changeset directory**

Create `.changeset/README.md`:

```markdown
# Changesets

Hello and welcome! This folder has been automatically generated by `@changesets/cli`, a build tool that works
with multi-package repos, or single-package repos to help you version and publish your code. You can
find the full documentation for it [in our repository](https://github.com/changesets/changesets)

We have a quick list of common questions to get you started engaging with this project in
[our documentation](https://github.com/changesets/changesets/blob/main/docs/common-questions.md)
```

**Step 3: Verify configuration is valid**

Run: `pnpm changeset status`

Expected: Output should show "No changesets found" (not an error about invalid config)

**Step 4: Commit**

```bash
git add .changeset/
git commit -m "$(cat <<'EOF'
chore: add changesets configuration

Configures @changesets/cli for single-package release management.
Uses public access and main as base branch.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

### Task 3: Add changeset-related package.json scripts

**Files:**

- Modify: `/Users/brajkovic/Code/containerfile-ts/.worktrees/changesets-ci-cd-migration/package.json:17-25`

**Step 1: Add new scripts**

Update the `scripts` section in `package.json` to include changeset commands:

```json
{
  "scripts": {
    "build": "tsc",
    "typecheck": "tsc --noEmit",
    "test": "vitest run",
    "test:watch": "vitest",
    "lint": "oxlint",
    "lint:fix": "oxlint --fix",
    "prepare": "husky",
    "changeset": "changeset",
    "changeset-version": "changeset version",
    "release": "pnpm build && pnpm publish --access public --no-git-checks"
  }
}
```

New scripts:

- `changeset` - Interactive changeset creation
- `changeset-version` - Applies changesets to bump versions
- `release` - Builds and publishes (used by CI)

**Step 2: Verify scripts work**

Run: `pnpm changeset status`

Expected: "No changesets found" message

Run: `pnpm changeset --help`

Expected: Help output from @changesets/cli

**Step 3: Commit**

```bash
git add package.json
git commit -m "$(cat <<'EOF'
chore: add changeset scripts to package.json

Adds changeset, changeset-version, and release scripts for
changesets-based release workflow.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

---

**Phase 1 Complete When:**

- `pnpm changeset status` runs without configuration errors
- All changeset dependencies are installed
- `.changeset/config.json` exists with valid configuration
